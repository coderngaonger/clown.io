<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ch·ª•p ·∫£nh + L·∫•y v·ªã tr√≠</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
        video, canvas { width: 100%; border: 1px solid #ccc; border-radius: 8px; margin-top: 10px; }
        button { padding: 10px 16px; margin-top: 10px; cursor: pointer; }
        #status { margin-top: 10px; font-size: 14px; }
        #preview { margin-top: 10px; }
    </style>
</head>
<body>
    <h2>Ch·ª•p ·∫£nh realtime & l·∫•y v·ªã tr√≠</h2>

    <!-- Hi·ªÉn th·ªã camera -->
    <video id="video" autoplay playsinline></video>
    <button id="captureBtn">üì∏ Ch·ª•p ·∫£nh & L·∫•y v·ªã tr√≠</button>

    <!-- ·∫¢nh sau khi ch·ª•p -->
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="preview" alt="·∫¢nh ƒë√£ ch·ª•p" />

    <div id="status"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const statusDiv = document.getElementById('status');
        const captureBtn = document.getElementById('captureBtn');

        // 1. M·ªü camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                statusDiv.textContent = "Camera ƒëang ho·∫°t ƒë·ªông.";
            } catch (err) {
                console.error(err);
                statusDiv.textContent = "Kh√¥ng m·ªü ƒë∆∞·ª£c camera: " + err.message;
            }
        }

        startCamera();

        // 2. H√†m ch·ª•p ·∫£nh + l·∫•y v·ªã tr√≠
        captureBtn.addEventListener('click', () => {
            // Ch·ª•p ·∫£nh t·ª´ video
            const width = video.videoWidth;
            const height = video.videoHeight;

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, width, height);

            // Chuy·ªÉn ·∫£nh th√†nh base64
            const imageData = canvas.toDataURL('image/png');
            preview.src = imageData;

            statusDiv.textContent = "ƒêang l·∫•y v·ªã tr√≠...";

            // L·∫•y v·ªã tr√≠ GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude;
                        const lon = pos.coords.longitude;
                        statusDiv.textContent = `V·ªã tr√≠: ${lat}, ${lon}`;

                        console.log("·∫¢nh (base64): ", imageData);
                        console.log("Lat:", lat, "Lon:", lon);

                        // G·ª≠i l√™n server (v√≠ d·ª•)
                        // fetch('/api/upload', {
                        //     method: 'POST',
                        //     headers: { 'Content-Type': 'application/json' },
                        //     body: JSON.stringify({
                        //         image: imageData,
                        //         latitude: lat,
                        //         longitude: lon
                        //     })
                        // }).then(res => res.json())
                        //   .then(data => console.log(data));
                    },
                    (err) => {
                        statusDiv.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠: " + err.message;
                    }
                );
            } else {
                statusDiv.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ geolocation.";
            }
        });
    </script>
</body>
</html>
